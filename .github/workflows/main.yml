name: Daily Market Monitor

# 必须赋予写权限，否则无法保存 CSV
permissions:
  contents: write

on:
  schedule:
    # --- 1. 早盘计划 ---
    # 北京/马来西亚时间 08:30 (UTC 00:30)
    - cron: '30 0 * * 1-5'
    
    # --- 2. 晚盘更新 (美股开盘后) ---
    # 夏令时 (3月-11月): UTC 13:50
    - cron: '50 13 * * 1-5'
    
    # 冬令时 (11月-3月): UTC 14:50
    - cron: '50 14 * * 1-5'

  # 允许手动点击按钮测试
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' # 建议用 3.10 或 3.9

      # 3. 安装依赖
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. 【关键修复】先配置 Git 并拉取最新代码
      # 这步必须在运行脚本之前，防止 CSV 文件冲突
      - name: Configure Git & Pull
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # 使用 rebase 策略拉取，防止合并冲突
          git pull origin main --rebase || echo "Git pull failed or nothing to pull"

      # 5. 运行脚本 (只跑这一次！)
      - name: Run trading script
        env: 
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python main.py

      # 6. 提交并推送变化
      - name: Commit and Push CSV
        run: |
          # 1. 配置身份
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 2. 【关键】先把文件存入本地仓库 (Add & Commit)
          # 只有 Commit 了，文件才不会被视为“Untracked”，git pull 也就不会报错了
          git add market_record.csv
          git commit -m "Update market record" || echo "No changes to commit"
          
          # 3. 本地存好后，再拉取远程更新 (使用 --rebase 避免产生分叉)
          git pull --rebase origin main
          
          # 4. 最后推送到远程
          git push origin main
